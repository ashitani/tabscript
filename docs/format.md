# TabScript フォーマット仕様

## 基本構文

### メタデータ
- `$title="曲名"` - 曲のタイトル
- `$tuning="guitar"` - チューニング（デフォルトは"guitar"）
- `$beat="4/4"` - 拍子（デフォルトは"4/4"）

### 改ページ（$newpage）
- `$newpage` を記述した位置でスコアの改ページを行うことができます。
- `$newpage` は小節間に記述してください。
- 改ページはPDFや画像などのレンダリング時に反映されます。
- 例：
```
$title="Test"
$tuning="guitar"
$beat="4/4"

$section="Intro"
1-0:4 2-2:4 3-4:4 4-5:4
1-0:4 2-2:4 3-4:4 4-5:4

$newpage

$section="Main"
1-0:4 2-2:4 3-4:4 4-5:4
1-0:4 2-2:4 3-4:4 4-5:4
```

### セクション
- セクションはメタデータとして `$section="セクション名"` で指定する
- 例: `$section="A"`, `$section="Chorus"`
- セクション名の角かっこ `[セクション名]` 記法は廃止

### 小節
- 小節は改行で区切る
- 1行に1小節を記述
- コメントは`#`または`//`で始まる行
- 行中・行末のコメントは`//`で記述

### 音符
- `弦-フレット:音価` - 基本形式（例：`3-3:4`は3弦3フレットの4分音符）
- 音価を省略すると直前の音価を継承
- 弦番号を省略すると直前の弦番号を継承
- `r音価` - 休符（例：`r4`は4分休符）
- `(音符1 音符2):音価` - 和音（例：`(3-3 4-4):4`）

### コード
- `@コード名` - コード名の指定（例：`@Cmaj7`）
- コード名は次のコード指定まで有効

### 繰り返し構造

小節の繰り返しとn番カッコを表現するための記法です：

#### 基本的な繰り返し
```
# 以下の小節は2回繰り返される
{
3-3:4 4-4:4
}
```

#### n番カッコ
```
# 共通部分から始まる繰り返し
{
3-3:4 4-4:4

# 1番カッコの部分
{1
5-5:4 6-6:4
1}

# 2番カッコの部分
{2
1-1:4 2-2:4
2}
}
```

注意：n番カッコ（{1, {2など）は必ず無印カッコ（{）の内部に配置する必要があります。
無印カッコの外にn番カッコを配置することはできません。

## 例
```
$title="Sample Song"
$beat="4/4"

[Intro]
# 1小節目
@Cmaj7 3-3:4 4-4:4

# 2小節目から繰り返し開始
{
@Dm7 5-5:4 6-6:4

# 1番カッコ（3小節目）
{1
@Em7 3-3:4 4-4:4
1}

# 2番カッコ（3小節目の別バージョン）
{2
@Am7 1-1:4 2-2:4
2}
}
```

## メタデータ

ファイルの先頭に記述する設定情報です：

- `$title="..."` : 曲のタイトル
- `$tuning="..."` : 楽器とチューニング
  - `"guitar"` : 6弦ギター（標準）
  - `"guitar7"` : 7弦ギター
  - `"bass"` : 4弦ベース
  - `"bass5"` : 5弦ベース
  - `"ukulele"` : ウクレレ
- `$beat="..."` : 拍子（例: "4/4", "3/4"）

## セクション

TabScriptでは、スコアを複数のセクションに分割することができます。セクションは以下の2つの方法で指定できます：

1. 明示的なセクション指定
   - `[セクション名]`の形式で指定
   - 例：`[Intro]`, `[A]`, `[B]`, `[Chorus]`

2. デフォルトセクション
   - セクション名を指定しない場合、デフォルトセクションとして扱われる
   - デフォルトセクションは、次の明示的なセクション指定が出現するまで継続する
   - デフォルトセクションの名前は表示されない

### セクションの例

```
5-1:4 4-2:4 3-3:4 2-4:4

[Chorus]
1-0:4 2-0:4 3-0:4 4-0:4
```

この例では：
- 最初の行はデフォルトセクションに含まれる
- `[Chorus]`以降の行は`Chorus`セクションに含まれる
- デフォルトセクションの名前は表示されない

### セクションの制約

1. 空のデフォルトセクション
   - セクション名が明示された時点で、デフォルトセクションが空（小節が1つもない）の場合、そのセクションは破棄される
   - これにより、不要な空のデフォルトセクションが作成されることを防ぐ

2. セクションの順序
   - セクションは出現順に処理される
   - デフォルトセクションは、明示的なセクション指定が出現するまで継続する

3. セクションの内容
   - 各セクションは1つ以上の小節を含む必要がある
   - 空のセクションは作成されない

## 音符の記法

### 基本形式
```
弦番号-フレット番号:音価
```
例：
- `1-3:4` : 1弦の3フレットを4分音符で
- `6-0:8` : 6弦の開放弦を8分音符で

### 休符
```
r音価
```
例：
- `r4` : 4分休符
- `r8` : 8分休符

### 和音
```
(弦-フレット 弦-フレット ...):音価
```
例：
- `(1-3 2-5 3-4):4` : 3つの音を同時に4分音符で

### ミュート
```
弦-x
```
または
```
弦-X
```
例：
- `6-x:8` : 6弦をミュートして8分音符で
- `(1-3 2-5 6-x):4` : 和音の中でミュート

### 音価
- `1` : 全音符
- `2` : 2分音符
- `4` : 4分音符
- `8` : 8分音符
- `16` : 16分音符
- `.` : 付点（例: `8.`は付点8分音符）

### 省略記法

直前の設定を継承することで、記述を簡略化できます：

1. 弦番号の省略（直前の弦番号を継承）：
```
3-0:8 2 3 5  # 全て3弦で演奏
```

2. 音価の省略（直前の音価を継承）：
```
3-0:8 4-0 5-0  # 全て8分音符
```

3. 弦移動と組み合わせた例：
```
3-0:8 u2 d0  # 3弦→2弦→3弦と移動、全て8分音符
```

## コード

コードネームを`@`で始めて記述します：
```
@Am 6-0:4 5-0:4  // Amコードを表示
```

小節の途中でコードを変更する場合：
```
@Am 6-0:4 @C 5-3:4  // 途中でAmからCに変更
```

## 省略可能な要素とデフォルト値

以下の要素は省略可能です：

### メタデータ
- `$title` - デフォルト: `""`（空文字列）
- `$tuning` - デフォルト: `"guitar"`（6弦ギター）
- `$beat` - デフォルト: `"4/4"`
- `$bars_per_line` - デフォルト: `4`（1行あたりの小節数）

### セクション
- セクション名（`[名前]`）- デフォルト: `""`（空文字列）
  - セクション名を省略すると、セクション名が表示されません

### 音符
- 弦番号 - デフォルト: 直前の音符の弦番号（初期値は`1`）
- 音価（`:8`など） - デフォルト: 直前の音符の音価（初期値は`4`=4分音符）
- コード名（`@Am`など） - デフォルト: なし

### 例：省略記法の使用

```
# フル記法
$title="Example"
$tuning="guitar"
$beat="4/4"

[A]
@Am 6-0:4 5-0:4 4-0:4 3-0:4

# 最小限の記法（全て省略）
6-0 5-0 4-0 3-0

# 音価を1回だけ指定（継承される）
6-0:8 5-0 4-0 3-0

# 弦番号の継承と相対指定
6-0 d0 d0 d0  # 6弦→5弦→4弦→3弦
```

## コメント

TabScriptでは以下の3種類のコメントをサポートします：

### 行頭コメント
行頭に`#`または`//`を置くことで、その行全体をコメントとして扱います：
```
# これは行全体がコメントになります
// これも行全体がコメントになります
# 以下の小節は4分音符を4つ含みます
3-3:4 4-4:4 5-5:4 6-6:4
```

### 行末コメント
行末に`//`を置くことで、その行の残りをコメントとして扱います：
```
3-3:4 4-4:4 // これは4分音符2つ
@Am 6-0:4 // これはAmコード
```

### 複数行コメント
三重引用符（`'''`）または二重引用符（`"""`）で囲むことで、複数行のコメントを記述できます：
```
'''
これは複数行の
コメントです
'''
```

注意：
- 行頭コメントと行末コメントは混在できません
- 行末コメントは音符やコードの後にのみ記述できます
- 複数行コメントは独立した行として記述する必要があります

## スラーとタイ

音符の後に`&`を付けることで、次の音符とのスラーまたはタイを表現できます：

```
# スラー（異なる音程をつなぐ）
3-3:4& 3-5:4

# タイ（同じ音程をつなぐ）
3-3:4& 3-3:4

# 3音以上の連続したスラー
3-3:8& 3-5:8& 3-7:8 3-8:8

# 3音以上の連続したタイ（同じ音を延ばす）
3-3:4& 3-3:4& 3-3:4 # 3つの音符を繋げて4分音符3つ分の長さに
```

スラー/タイは小節をまたいで使用することもできます：
```
3-3:4& | 3-5:4

# 小節をまたぐ3音以上のスラー
3-3:4& | 3-5:4& 3-7:4
```

## 繰り返し記号

繰り返し記号には`{}`を使用します：

```
# 基本的な繰り返し（2回繰り返し）
{
3-3:4 4-4:4
}
```

# 1番括弧、2番括弧付きの繰り返し
{
3-3:4 4-4:4

{1
5-5:4 6-6:4
1}

{2
1-1:4 2-2:4
2}
}
```

### 繰り返し記号の種類

- `{` - 繰り返し開始
- `}` - 繰り返し終了
- `{n` - n番括弧開始（例：`{1`、`{2`）
- `n}` - n番括弧終了（例：`1}`、`2}`）

### 繰り返し記号の組み合わせ規則

1. 基本的な繰り返し
   - `{`で始まった繰り返しは必ず`}`で閉じられる必要がある
   - 例：
     ```
     {
     3-3:4 4-4:4
     }
     ```

2. n番カッコ
   - `{n`で始まったn番カッコは必ず`n}`で閉じられる必要がある
   - 1番カッコが存在する場合は2番カッコは必ず存在する必要がある
   - 最も大きい番号のn番カッコを閉じた時点で、その繰り返し全体も閉じられる必要がある
   - 例：
     ```
     {
     3-3:4 4-4:4
     {1
     5-5:4 6-6:4
     1}
     {2
     1-1:4 2-2:4
     2}
     }
     ```

3. 複数のn番カッコ
   - 同じ番号のn番カッコは1つの繰り返し内に1つだけ存在できる
   - 例：
     ```
     {
     3-3:4 4-4:4
     {1
     5-5:4 6-6:4
     1}
     {2
     1-1:4 2-2:4
     2}
     }
     ```

4. 無印カッコとn番カッコの包含関係
   - 無印カッコ（`{...}`）は、その中に含まれる全てのn番カッコを包含する必要がある
   - 例：
     ```
     {
     3-3:4 4-4:4
     {1
     5-5:4 6-6:4
     1}
     {2
     1-1:4 2-2:4
     2}
     }
     ```

## 繰り返し構造と小節の関係

TabScriptでは、繰り返し記号は小節単位で適用されます：

1. 各行は基本的に1つの小節を表します
2. 繰り返し記号（`{`と`}`）は小節の前後に配置されます
3. 繰り返し開始記号と終了記号は、それぞれ独立した行に配置できます

例：

```
{ // 繰り返し開始
1-0:4 1-2:4 // 1小節目
3-0:4 3-2:4 // 2小節目
} // 繰り返し終了
```

### 弦移動表記

弦を上下に移動する特殊記法として、以下を使用できます：

```
u[フレット]:音価  # 1弦分上に移動（Up）
d[フレット]:音価  # 1弦分下に移動（Down）
```

例：
- `3-0:4 u0:4` : 3弦の後、1弦上の2弦でフレット0を演奏
- `1-0:4 d0:4` : 1弦の後、1弦下の2弦でフレット0を演奏
- `2-0:8 u2:8` : 2弦の後、1弦上の1弦でフレット2を演奏

重要なポイント：
- `u`/`d`の後の数値は弦の移動数ではなく、演奏するフレット番号です
- 弦の移動は常に1弦分のみです
- すでに1弦の状態で`u`（上方向移動）することはできません
- すでに最低弦の状態で`d`（下方向移動）することはできません（6弦ギターの場合は6弦より下には移動できない）

### 省略記法

直前の設定を継承することで、記述を簡略化できます：

1. 弦番号の省略（直前の弦番号を継承）：
```
3-0:8 2 3 5  # 全て3弦で演奏
```

2. 音価の省略（直前の音価を継承）：
```
3-0:8 4-0 5-0  # 全て8分音符
```

3. 弦移動と組み合わせた例：
```
3-0:8 u2 d0  # 3弦→2弦→3弦と移動、全て8分音符
```

## 連符（三連符・五連符など）の表記

### 基本構文
- `[ ... ]3` で囲まれた範囲を「三連符グループ」とみなす
- `[ ... ]5` なら五連符、`[ ... ]7` なら七連符なども拡張可能
- グループ内の音符は通常通り表記できる（4分音符、8分音符、16分音符、付点音符など）
- グループ全体の長さは「元の音価×2/3」（三連符の場合）に圧縮される

例：
```
[ 1-0:4 2-0:4 3-0:4 ]3  # 4分音符の三連符
[ 1-0:8 2-0:8 3-0:8 4-0:8 5-0:8 ]5  # 8分音符の五連符
```

注意点：
- 連符グループ内の音符数は、指定した連符数と一致する必要があります
- 連符グループ内では休符やミュート音符も使用可能です
- 連符グループ内の音符は、通常の音符と同じように音価を指定できます

### 小節リピート

前の小節を繰り返す場合は、`...`を使用します。数字を付けることで、指定した小節数分のリピートを表します。

```
C G
...
...2
...4
```

- `...` - 1小節リピート（直前の小節を1回繰り返す）
- `...2` - 2小節リピート（直前の2小節を1回繰り返す）
- `...4` - 4小節リピート（直前の4小節を1回繰り返す）

リピート記号は、必ず小節の先頭に配置する必要があります。