# 実装仕様

## プロジェクト構造

```
src/tabscript/
├── __init__.py      # パブリックAPIの定義
├── models.py        # データモデル定義
├── parser/          # パース処理関連
│   ├── __init__.py
│   ├── parser.py    # メインのパーサー
│   ├── preprocessor.py  # テキスト前処理
│   ├── analyzer.py  # 構造解析
│   ├── validator.py # バリデーション
│   ├── analyzer/    # 詳細な解析処理
│   └── builder/     # スコア構築処理
├── renderer.py      # レンダリング処理
├── style.py         # スタイル定義
├── exceptions.py    # 例外定義
└── cli.py          # コマンドラインインターフェース
```

## パース処理の流れ

TabScriptのパース処理は以下の順序で実行されます：

1. パース処理の全体フロー
   ```python
   # Parser.parse()内での処理順序
   preprocessor.preprocess()  # テキストの前処理
   analyzer.analyze()        # 構造解析
   validator.validate()      # バリデーション
   score_builder.build_score()  # スコア構築
   ```

2. 前処理フェーズ (`preprocessor.py`)
   - `_clean_text()`: コメントの除去
     - 行頭コメント（`#`または`//`で始まる行）
     - 行末コメント（`//`以降）
     - 複数行コメント（`'''`または`"""`で囲まれた部分）
   - `_normalize_empty_lines()`: 空行の正規化
     - 連続する空行を1行に
     - セクション区切りの空行は2行に
   - `_normalize_all_brackets()`: 括弧の正規化
     - 繰り返し記号（`{`と`}`）の一行化
     - n番カッコ（`{n`と`n}`）の一行化
     - 括弧と内容の間にスペースを挿入

3. 構造解析フェーズ (`analyzer.py`)
   - `analyze()`: メインの解析処理
     - `_parse_metadata()`: メタデータの解析
       - `$title`、`$tuning`、`$beat`などの設定
     - `_parse_sections()`: セクションの解析
       - セクション名の抽出
       - 小節の構造解析
     - `_parse_bars()`: 小節の解析
       - 基本音符（`弦-フレット:音価`）
       - 休符（`r音価`）
       - 和音（`(音符1 音符2):音価`）
       - コード（`[コード名]`）

4. バリデーションフェーズ (`validator.py`)
   - `validate()`: メインの検証処理
     - `_validate_metadata()`: メタデータの検証
     - `_validate_sections()`: セクション構造の検証
     - `_validate_bars()`: 小節の長さ検証
     - `_validate_notes()`: 音符の整合性検証
     - `_validate_chords()`: コードの整合性検証

5. スコア構築フェーズ (`builder/score.py`)
   - `build_score()`: メインの構築処理
     - `_build_sections()`: セクションの構築
       - デフォルトセクションの処理
       - 名前付きセクションの処理
     - `_build_bars()`: 小節の構築
       - 音符の構築
       - コードの構築
     - `_organize_bars_into_columns()`: レイアウトの構築
       - 行あたりの小節数に基づくカラム分割

## データモデル

### スコア構造
- `Score`: スコア全体を表す
  - `metadata`: メタデータ（タイトル、チューニング、拍子など）
  - `sections`: セクションのリスト

### セクション構造

#### セクションの解析

1. デフォルトセクションの処理
   - セクション名が指定されていない場合、デフォルトセクションとして扱う
   - `name`を空文字列（`""`）に設定
   - `is_default`を`True`に設定
   - 次のセクション名が指定されるまで、すべての小節をこのセクションに追加

2. 明示的なセクションの処理
   - `[セクション名]`の形式で指定された場合、新しいセクションを作成
   - `name`に指定されたセクション名を設定
   - `is_default`を`False`に設定
   - 前のセクションが空のデフォルトセクションの場合、そのセクションを破棄

3. セクションの保存
   - セクションは`Section`クラスのインスタンスとして管理
   - 各セクションは以下の属性を持つ：
     - `name`: セクション名（デフォルトセクションの場合は空文字列）
     - `is_default`: デフォルトセクションかどうか
     - `bars`: 小節のリスト
     - `columns`: カラムのリスト（レイアウト用）

#### セクションの構築

1. デフォルトセクションの作成
   ```python
   section = Section(
       name="",  # 空文字列でデフォルトセクションを表現
       is_default=True,
       bars=[],
       columns=[]
   )
   ```

2. 明示的なセクションの作成
   ```python
   section = Section(
       name="セクション名",
       is_default=False,
       bars=[],
       columns=[]
   )
   ```

3. 空のデフォルトセクションの処理
   ```python
   if current_section.is_default and not current_section.bars:
       # 空のデフォルトセクションを破棄
       sections.pop()
   ```

#### セクションのレンダリング

1. デフォルトセクション
   - セクション名を表示しない
   - 小節のみを表示

2. 明示的なセクション
   - セクション名を表示
   - その下に小節を表示

3. レイアウト
   - 各セクションは独立したブロックとして表示
   - セクション間は空行で区切る

### 小節構造
- `Bar`: 小節を表す
  - `notes`: 音符のリスト
  - `chords`: コードのリスト
  - `repeat_start`: 繰り返し開始フラグ
  - `repeat_end`: 繰り返し終了フラグ
  - `volta_start`: n番カッコ開始フラグ
  - `volta_end`: n番カッコ終了フラグ
  - `volta_number`: n番カッコの番号

### 音符構造
- `Note`: 音符を表す
  - `string`: 弦番号
  - `fret`: フレット番号
  - `duration`: 音価（`Fraction`型）
  - `is_rest`: 休符フラグ
  - `is_muted`: ミュートフラグ
  - `tuplet`: 連符グループ情報（例: `{"size": 3, "group_id": 1}`）

### コード構造
- `Chord`: コードを表す
  - `name`: コード名
  - `position`: 小節内での位置

## 音符のステップ数計算

音符の長さ（ステップ数）は、`Fraction`クラスを使用して有理数で表現します。これにより、三連符などの特殊な音符も正確に表現できます。

### 基本的な考え方
- 4分音符を基本単位として`Fraction(1)`とする
- 全音符は`Fraction(4)`（4分音符4つ分）
- 2分音符は`Fraction(2)`（4分音符2つ分）
- 8分音符は`Fraction(1, 2)`（4分音符の半分）
- 16分音符は`Fraction(1, 4)`（8分音符の半分）
- 32分音符は`Fraction(1, 8)`（16分音符の半分）
- 64分音符は`Fraction(1, 16)`（32分音符の半分）

### 付点音符
付点音符は基本の音符の長さの1.5倍になります：
- 付点4分音符: `Fraction(1) * Fraction(3, 2) = Fraction(3, 2)`
- 付点8分音符: `Fraction(1, 2) * Fraction(3, 2) = Fraction(3, 4)`

### 小節の長さ検証
小節の長さは拍子記号に基づいて計算されます：
- 4/4拍子の場合: `Fraction(4, 4) * 4 = Fraction(4)` (4分音符4つ分)
- 3/4拍子の場合: `Fraction(3, 4) * 4 = Fraction(3)` (4分音符3つ分)
- 6/8拍子の場合: `Fraction(6, 8) * 4 = Fraction(3)` (4分音符3つ分)

小節内の全ての音符のステップ数の合計が、期待される小節の長さと一致するかを検証します。

## 小節の定義

TabScriptにおける小節は以下のように定義されます：

1. 基本構造
   - 1小節は1行のpreprocessedテキストからなる
   - 1行のテキストは必ず1小節として扱われる
   - 複数行のテキストは複数の小節として扱われる

2. 小節の長さ
   - メタデータで拍子が指定されていない場合は4/4拍子がデフォルト
   - 4/4拍子の場合、1小節は4分音符4つ分の長さ
   - 小節内の音符の合計の長さは、指定された拍子の長さと一致する必要がある
   - 例：
     - 4/4拍子の場合：4分音符4つ、または2分音符2つ、または全音符1つなど
     - 3/4拍子の場合：4分音符3つ、または2分音符1つと4分音符1つなど

3. 音符の長さ表記
   - 音符の長さは`-`の後に数字で指定
   - 数字は拍子の分母に対する比率を表す
   - 例：
     - `1-0:4` は4分音符
     - `1-0:2` は2分音符
     - `1-0:1` は全音符

## 連符（三連符・五連符など）の実装仕様

### パース段階
- `{ ... }3` のような連符グループをパース時に検出し、グループ内の各Noteに「連符グループ情報（例: tuplet={"size": 3, "group_id": ...}）」を付与する。
- Noteの`duration`は「表記上の音価」（例: "4"）のまま保持する。
- BarやSectionにも「この範囲は連符グループ」と分かる情報を持たせる（必要に応じて）。

### データモデル
- Noteクラスに`tuplet`属性（例: `{"size": 3, "group_id": 1}`）を追加し、三連符・五連符などのグループ情報を保持する。
- 休符やミュートも連符グループ内で同様に扱う。

### レンダリング段階
- NoteやBarの`tuplet`属性を参照し、連符グループの開始・終了を判定する。
- レンダラー内部で、連符グループ内の音符は「通常の音価をグループ全体の長さに合わせてスケーリング」して描画位置・長さを計算する。
  - 例：4分音符三連符なら、1音あたり全音符の1/3の長さで描画。
- 連符グループの先頭・末尾を検出し、グループ全体に「3」や「5」などの旗や括弧を描画する。

### メリット
- パース段階では「表記上の音価」をそのまま保持できるため、TabScriptの記述と内部表現が直感的に一致する。
- レンダラーで柔軟にスケーリングや旗の描画ができる。
- 将来的に「連符内でさらに細かい音価や複雑な混在」も拡張しやすい。

### 例：Noteのデータ構造（イメージ）
```python
class Note:
    ...
    duration: str  # "4"など
    tuplet: Optional[dict]  # 例: {"size": 3, "group_id": 1} なら三連符グループ1
```

## Note.durationとNote.stepの違い

- `duration` … TabScript譜面上の**表記音価**（例: "4"、"8." などの文字列）。パース時にそのまま保持される。
- `step` … **絶対音価**（`Fraction`型）。実際の長さ（4分音符なら`Fraction(1)`、8分音符なら`Fraction(1,2)`など）。
    - 通常音符の場合、`duration`と`step`は必ず一致する（例: duration="4" → step=Fraction(1)）。
    - 連符グループ（例: 三連符）内の音符の場合、`duration`は表記通りだが、`step`はスケーリングされる（例: duration="4" → step=Fraction(2,3)）。

- **小節内の合計音価チェックやレンダリング時の長さ計算は、必ず`step`を使うこと。**
- `duration`はあくまで譜面表記の再現やデバッグ用。

