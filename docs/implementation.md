# 実装仕様

## パース処理のフェーズ

パースは以下のフェーズで順次処理されます。各フェーズの出力が次のフェーズの入力となります。

1. コメント除去フェーズ
- 行末コメント（`# comment`）を除去
- コメント行を除去
```
# コメント
{ # 繰り返し開始
1-1:4 2-2:4  # 小節1
} # 繰り返し終了
```
↓
```
{
1-1:4 2-2:4
}
```

2. 空行正規化フェーズ
- 連続する空行を1行に
- セクション区切り以外の空行を除去
- セクション区切りの空行は2行に正規化

3. 繰り返し記号の一行化フェーズ
- 複数行の繰り返し記号を1行に結合
- 括弧と内容の間にスペースを挿入
```
{
1-1:4 2-2:4
}
```
↓
```
{ 1-1:4 2-2:4 }
```

4. n番カッコの一行化フェーズ
- 複数行のn番カッコを1行に結合
- 括弧と内容の間にスペースを挿入
- 終了括弧に番号を付加
```
{1
1-1:4 2-2:4
1}
```
↓
```
{1 1-1:4 2-2:4 }1
```

## パーサーの入力形式

`_analyze_section_bars`メソッドは、全ての前処理フェーズが完了した後の入力を想定しています：

- 繰り返し記号は`{ content }`形式
- n番カッコは`{n content }n`形式
- コメントは除去済み
- 不要な空行は除去済み

## 繰り返しとn番カッコのフラグ

### 繰り返し記号のフラグ
- `repeat_start`: 繰り返しの開始を示す。`{ content }`形式の小節に設定
- `repeat_end`: 繰り返しの終了を示す。`{ content }`形式の小節に設定

### n番カッコのフラグ
- `volta_start`: n番カッコの開始を示す。`{n content }n`形式の小節に設定
- `volta_end`: n番カッコの終了を示す。`{n content }n`形式の小節に設定
- `volta_number`: n番カッコの番号を示す。n番カッコ内の全ての小節に設定

### 組み合わせの例
```
{ content1 }        # repeat_start=True, repeat_end=True
{1 content2 }1      # volta_start=True, volta_end=True, volta_number=1
{2 content3 }2      # volta_start=True, volta_end=True, volta_number=2
```

これらのフラグは、後続の処理（レンダリングなど）で繰り返し記号やn番カッコを適切に描画するために使用されます。 