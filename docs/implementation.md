# 実装仕様

## パース処理のフェーズ

パースは以下のフェーズで順次処理されます。各フェーズの出力が次のフェーズの入力となります。

1. コメント除去フェーズ
- 行末コメント（`# comment`）を除去
- コメント行を除去
```
# コメント
{ # 繰り返し開始
1-1:4 2-2:4  # 小節1
} # 繰り返し終了
```
↓
```
{
1-1:4 2-2:4
}
```

2. 空行正規化フェーズ
- 連続する空行を1行に
- セクション区切り以外の空行を除去
- セクション区切りの空行は2行に正規化

3. 繰り返し記号の一行化フェーズ
- 複数行の繰り返し記号を1行に結合
- 括弧と内容の間にスペースを挿入
- 繰り返し開始記号（`{`）はその後の小節に付随する特性
- 繰り返し終了記号（`}`）はその前の小節に付随する特性

例：
```
{
1-1:4 2-2:4
}
```
↓
```
{ 1-1:4 2-2:4 }
```

4. n番カッコの一行化フェーズ
- 複数行のn番カッコを1行に結合
- 括弧と内容の間にスペースを挿入
- 終了括弧に番号を付加
- n番カッコ開始記号（`{n`）はその後の小節に付随する特性
- n番カッコ終了記号（`n}`）はその前の小節に付随する特性


例：
```
{1
1-1:4 2-2:4
1}
```
↓
```
{1 1-1:4 2-2:4 }1
```

5. n番カッコと繰り返し記号のネスト
- n番カッコと繰り返し記号はネストすることがある
- ネストした場合も処理は同様で、開始記号は直後の小節の属性、終了記号は直前の小節の属性としてカウントされる

例：

```
{
{1
1-1:4 2-2:4
1}
}
```
↓
```
{ {1 1-1:4 2-2:4 }1 }
```

ネストした終了記号の例：

```
1-1:4 2-2:4
2}
}
```
↓
```
1-1:4 2-2:4 2} }
```


## パーサーの入力形式

`_analyze_section_bars`メソッドは、全ての前処理フェーズが完了した後の入力を想定しています：

- 繰り返し記号は`{ content }`形式
- n番カッコは`{n content }n`形式
- コメントは除去済み
- 不要な空行は除去済み

## 繰り返しとn番カッコのフラグ

### 繰り返し記号のフラグ
- `repeat_start`: 繰り返しの開始を示す。`{ content }`形式の小節に設定
- `repeat_end`: 繰り返しの終了を示す。`{ content }`形式の小節に設定

### n番カッコのフラグ
- `volta_start`: n番カッコの開始を示す。`{n content }n`形式の小節に設定
- `volta_end`: n番カッコの終了を示す。`{n content }n`形式の小節に設定
- `volta_number`: n番カッコの番号を示す。n番カッコ内の全ての小節に設定

### 組み合わせの例
```
{ content1 }        # repeat_start=True, repeat_end=True
{1 content2 }1      # volta_start=True, volta_end=True, volta_number=1
{2 content3 }2      # volta_start=True, volta_end=True, volta_number=2
```

これらのフラグは、後続の処理（レンダリングなど）で繰り返し記号やn番カッコを適切に描画するために使用されます。

## 音符のステップ数計算

音符の長さ（ステップ数）は、`Fraction`クラスを使用して有理数で表現します。これにより、三連符などの特殊な音符も正確に表現できます。

### 基本的な考え方
- 4分音符を基本単位として`Fraction(1)`とする
- 全音符は`Fraction(4)`（4分音符4つ分）
- 2分音符は`Fraction(2)`（4分音符2つ分）
- 8分音符は`Fraction(1, 2)`（4分音符の半分）
- 16分音符は`Fraction(1, 4)`（8分音符の半分）
- 32分音符は`Fraction(1, 8)`（16分音符の半分）
- 64分音符は`Fraction(1, 16)`（32分音符の半分）

### 付点音符
付点音符は基本の音符の長さの1.5倍になります：
- 付点4分音符: `Fraction(1) * Fraction(3, 2) = Fraction(3, 2)`
- 付点8分音符: `Fraction(1, 2) * Fraction(3, 2) = Fraction(3, 4)`

### 小節の長さ検証
小節の長さは拍子記号に基づいて計算されます：
- 4/4拍子の場合: `Fraction(4, 4) * 4 = Fraction(4)` (4分音符4つ分)
- 3/4拍子の場合: `Fraction(3, 4) * 4 = Fraction(3)` (4分音符3つ分)
- 6/8拍子の場合: `Fraction(6, 8) * 4 = Fraction(3)` (4分音符3つ分)

小節内の全ての音符のステップ数の合計が、期待される小節の長さと一致するかを検証します。 