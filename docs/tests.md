# テスト仕様

## テストの実行方法

テストは以下のコマンドで実行できます：

```bash
# 全てのテストを実行
pytest

# 特定のテストファイルを実行
pytest tests/renderer/test_01_layout_calculator.py

# 特定のテスト関数を実行
pytest tests/renderer/test_01_layout_calculator.py::test_calculate_section_layout

# 詳細な出力で実行
pytest -v

```

## テストの追加方法

新しいテストを追加する際は、以下の点に注意してください：

1. テストファイルの選択
   - 機能に応じて適切なテストファイルを選択
   - レンダリング処理は `tests/renderer/` に
   - パース処理は `tests/parser/` に

2. テストケースの設計
   - 正常系と異常系の両方をテスト
   - エッジケースも考慮
   - テストケースは独立していること

3. テストの実装
   - テスト関数名は`test_`で始める
   - テストの説明をドキュメント文字列で記述
   - アサーションは具体的な値を指定

4. テストの実行と確認
   - 全てのテストが通ることを確認
   - カバレッジを確認
   - パフォーマンスを確認

# テスト構成

## フォルダ構成
```
tests/
├── data/           # テストデータ
├── integration/    # 統合テスト
├── parser/         # パース処理のテスト
└── renderer/       # レンダリング処理のテスト
```

## レンダリング処理のテスト

- `test_01_layout_calculator.py`: レイアウト計算のテスト
  - 小節幅の計算
  - 音符位置の計算
  - レイアウト検証（小節幅、間隔、ページレイアウト）

- `test_02_note_renderer.py`: 音符の描画テスト
  - フレット番号の描画
  - 音符の描画検証（位置、フレット番号、タイ・スラー）

- `test_03_triplet_renderer.py`: 三連符の描画テスト
  - 三連符記号の描画
  - 三連符の検証（位置、範囲）

- `test_04_volta_renderer.py`: ボルタブラケットの描画テスト
  - ボルタブラケットの描画
  - ボルタの検証（位置、番号）

- `test_05_repeat_renderer.py`: リピート記号の描画テスト
  - リピート記号の描画
  - リピートの検証（位置、ドット）

- `test_06_dummy_bar_renderer.py`: ダミー小節の描画テスト
  - ダミー小節の描画
  - ダミー小節の検証（斜め線、ドット）

- `test_07_bar_renderer.py`: 小節全体の描画テスト
  - 小節全体の描画
  - 小節の描画検証（小節線、弦、要素の配置）

- `test_08_renderer.py`: 全体のレンダリング処理のテスト
  - PDF生成
  - 全体の描画検証（タイトル、メタデータ、セクション、改ページ）

- `test_09_rendering_validator.py`: 描画検証のテスト
  - 描画検証の基本機能
  - 検証結果のレポート生成
  - 期待値との比較

## パース処理のテスト

- `test_01_preprocessor.py`: テキスト前処理のテスト
- `test_02_analyzer.py`: 構造解析のテスト
- `test_03_repeat_analyzer.py`: リピート解析のテスト
- `test_04_section_analyzer.py`: セクション解析のテスト
- `test_05_validator.py`: バリデーションのテスト
- `test_06_note_builder.py`: 音符構築のテスト
- `test_07_bar_builder.py`: 小節構築のテスト
- `test_08_score_builder.py`: スコア構築のテスト

## 描画検証の方針

### 検証項目

1. レイアウト
   - 小節幅の計算が正しいか
   - 小節間の間隔が適切か
   - ページレイアウトが正しいか
   - 改ページ位置が正しいか

2. 内容
   - 音符が正しい位置に描画されるか
   - コードが正しい位置に表示されるか
   - 三連符記号が正しい位置に描画されるか
   - ボルタブラケットが正しい位置に描画されるか
   - リピート記号が正しい位置に描画されるか

### 検証方法

1. 各レンダラーのテストに検証を組み込む
   - レイアウト計算の検証は `test_01_layout_calculator.py` に
   - 音符の描画検証は `test_02_note_renderer.py` に
   - 小節全体の描画検証は `test_07_bar_renderer.py` に
   - 全体の描画検証は `test_08_renderer.py` に

2. 検証結果のレポート
   - 期待値と実際の値を比較
   - エラーがある場合は具体的な位置と内容を報告
   - 検証結果を集計して全体の品質を評価

3. テストデータ
   - `tabs/` ディレクトリのタブファイルを使用
   - 各テストケースに対応する期待値を定義
   - エッジケースを含むテストケースを用意

### 今後の課題

1. 描画検証の自動化
   - 検証項目の追加
   - 検証方法の改善
   - レポート形式の改善

2. テストカバレッジの向上
   - 未テストの機能の特定
   - テストケースの追加
   - エッジケースの網羅

3. パフォーマンステストの追加
   - 描画処理の速度測定
   - メモリ使用量の測定
   - ボトルネックの特定

4. エラーケースの網羅
   - 異常系のテストケース追加
   - エラーメッセージの検証
   - エラー処理の改善
